<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Dealin Rates</title>
        <style>
            table {
                width: auto;
                border-collapse: collapse;
            }
            table,
            th,
            td {
                border: 1px solid black;
            }
            th,
            td {
                padding: 4px;
                text-align: center;
            }
            body {
                margin-bottom: 200px;
            }
        </style>
        <script src="https://cdn.plot.ly/plotly-3.1.0.min.js"></script>
    </head>
    <body style="line-height: 1.3" ;>
        <h2>Dealin Rates</h2>
        Data from Statistical Mahjong Strategy<br />
        Half suji A refers to 46 that is half suji by 19. Half suji B refers to 46 that is half suji by 37.<br />
        <br />
        <form id="plotForm">
            <label for="earlyTurn">Early Turn:</label>
            <input type="number" id="earlyTurn" name="earlyTurn" value="9" min="1" max="19" />
            <label for="lateTurn">Late Turn:</label>
            <input type="number" id="lateTurn" name="lateTurn" value="15" min="1" max="19" />
            <label for="simple">Simple</label>
            <input type="checkbox" id="simple" name="simple" checked />
        </form>

        <div style="display: flex; justify-content: flex-start">
            <table id="full-dealin-table" style="margin: 10px">
                <thead>
                    <tr>
                        <th>Type \ Turn</th>
                        <th>1</th>
                        <th>2</th>
                        <th>3</th>
                        <th>4</th>
                        <th>5</th>
                        <th>6</th>
                        <th>7</th>
                        <th>8</th>
                        <th>9</th>
                        <th>10</th>
                        <th>11</th>
                        <th>12</th>
                        <th>13</th>
                        <th>14</th>
                        <th>15</th>
                        <th>16</th>
                        <th>17</th>
                        <th>18</th>
                        <th>19</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <table id="short-table-1" style="margin: 10px">
                <thead>
                    <tr>
                        <th>Type \ Turn</th>
                        <th>9</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <table id="short-table-2" style="margin: 10px">
                <thead>
                    <tr>
                        <th>Type \ Turn</th>
                        <th>15</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <script>
            const dealin_rates = {
                "Guest wind 2 visible": [1.2, 0.4, 0.3, 0.2, 0.2, 0.2, 0.2, 0.2, 0.2, 0.3, 0.3, 0.4, 0.5, 0.6, 0.8, 0.9, 1.2, 1.6, 2.1],
                "Yakuhai 2 visible": [0.5, 0.5, 0.3, 0.2, 0.2, 0.2, 0.2, 0.2, 0.3, 0.3, 0.4, 0.4, 0.5, 0.7, 0.8, 1.0, 1.3, 1.7, 2.8],
                "Suji 19": [1.8, 1.9, 1.8, 1.7, 1.7, 1.7, 1.7, 1.7, 1.8, 1.9, 2.0, 2.2, 2.4, 2.7, 3.0, 3.3, 3.6, 4.0, 5.0],
                "Guest wind 1 visible": [1.4, 1.3, 1.2, 1.2, 1.2, 1.3, 1.4, 1.6, 1.8, 2.1, 2.5, 3.0, 3.7, 4.4, 5.3, 6.5, 7.7, 9.4, 12.6],
                "Yakuhai 1 visible": [1.2, 1.2, 1.2, 1.1, 1.2, 1.3, 1.4, 1.6, 1.9, 2.2, 2.6, 3.1, 3.7, 4.4, 5.2, 6.2, 7.3, 8.5, 12.1],
                "Full suji 5": [0, 0.8, 1.6, 1.6, 1.7, 1.8, 2.0, 2.1, 2.2, 2.4, 2.5, 2.7, 3.0, 3.2, 3.4, 3.7, 3.9, 4.3, 5.1],
                "Full suji 46": [0, 2.6, 2.0, 2.0, 2.0, 2.0, 2.1, 2.2, 2.3, 2.4, 2.6, 2.7, 3.0, 3.1, 3.4, 3.6, 3.9, 4.2, 5.1],
                "Suji 28": [3.8, 3.5, 3.6, 3.8, 3.7, 3.7, 3.7, 3.8, 3.9, 4.0, 4.2, 4.4, 4.6, 4.9, 5.3, 5.7, 6.1, 6.6, 7.4],
                "Guest wind live": [2.4, 2.7, 2.6, 2.6, 2.8, 2.9, 3.2, 3.5, 4.0, 4.6, 5.1, 5.9, 6.6, 7.4, 8.4, 9.4, 10.5, 11.8, 14.7],
                "Yakuhai live": [2.1, 2.3, 2.4, 2.6, 2.9, 3.2, 3.6, 4.0, 4.6, 5.3, 6.0, 6.8, 7.8, 8.8, 9.9, 11.2, 12.4, 13.9, 18.1],
                "Suji 37": [5.6, 5.3, 5.2, 5.2, 5.3, 5.2, 5.3, 5.3, 5.5, 5.6, 5.7, 6.0, 6.2, 6.6, 7.0, 7.4, 8.0, 8.5, 9.8],
                "Half suji 46A": [2.5, 3.5, 4.1, 4.7, 5.1, 5.6, 6.1, 6.6, 7.2, 7.8, 8.5, 9.2, 10.0, 10.9, 11.8, 12.8, 13.8, 15.0, 17.5],
                "Non suji 19": [3.4, 4.0, 4.6, 5.1, 5.5, 5.9, 6.3, 6.8, 7.4, 8.0, 8.7, 9.4, 10.2, 11.1, 12.0, 13.1, 14.2, 15.4, 17.8],
                "Half suji 5": [2.5, 3.5, 4.3, 4.8, 5.3, 5.8, 6.3, 6.9, 7.4, 8.0, 8.7, 9.4, 10.2, 11.0, 11.9, 12.9, 14.0, 15.2, 17.5],
                "Half suji 46B": [3.1, 4.1, 4.9, 5.6, 6.0, 6.4, 6.8, 7.4, 7.9, 8.5, 9.2, 9.9, 10.6, 11.4, 12.3, 13.3, 14.4, 15.6, 17.5],
                "Non suji 28": [4.7, 5.2, 5.8, 6.2, 6.7, 7.1, 7.5, 8.0, 8.6, 9.2, 9.9, 10.6, 11.4, 12.3, 13.3, 14.3, 15.4, 16.7, 19.1],
                "Non suji 37": [5.8, 6.3, 6.7, 7.1, 7.5, 7.9, 8.4, 8.9, 9.5, 10.1, 10.8, 11.6, 12.4, 13.3, 14.3, 15.4, 16.6, 17.9, 20.4],
                "Non suji 5": [5.7, 6.6, 7.7, 8.5, 9.4, 10.2, 11.0, 11.9, 12.8, 13.8, 14.9, 16.0, 17.2, 18.5, 19.9, 21.3, 22.9, 24.7, 27.5],
                "Non suji 46": [5.7, 6.9, 8.0, 8.9, 9.7, 10.5, 11.3, 12.2, 13.1, 14.1, 15.1, 16.3, 17.5, 18.8, 20.1, 21.7, 23.2, 24.9, 27.8],
            };

            const passed_suji = {
                "Passed suji": [1.0, 1.7, 2.5, 3.2, 4.0, 4.8, 5.6, 6.3, 7.1, 7.8, 8.5, 9.2, 9.8, 10.5, 11.1, 11.6, 12.2, 12.7, 13.3],
            };

            const tables = [];
            tables.push(document.querySelector("#full-dealin-table"));
            tables.push(document.querySelector("#short-table-1"));
            tables.push(document.querySelector("#short-table-2"));

            function simplify_types() {
                const keyPairs = [
                    [["Half suji 46A", "Half suji 46B"], "Half suji 46"],
                    [["Yakuhai live", "Guest wind live"], "Honor live"],
                    [["Yakuhai 1 visible", "Guest wind 1 visible"], "Honor 1 visible"],
                    [["Yakuhai 2 visible", "Guest wind 2 visible"], "Honor 2 visible"],
                ];
                simple_dealin_rates = structuredClone(dealin_rates);
                for (const [[keyA, keyB], newKey] of keyPairs) {
                    simple_dealin_rates[newKey] = simple_dealin_rates[keyA].map((val, i) => (val + simple_dealin_rates[keyB][i]) / 2);
                    delete simple_dealin_rates[keyA];
                    delete simple_dealin_rates[keyB];
                }
            }
            function updateTable(earlyTurn, lateTurn, simple) {
                for (let tableNum = 0; tableNum < 3; tableNum++) {
                    let tbody = tables[tableNum].querySelector("tbody");
                    tbody.replaceChildren();
                    let sortKeys = {
                        0: 9,
                        1: earlyTurn,
                        2: lateTurn,
                    };
                    let sortKey = sortKeys[tableNum];
                    if (tableNum > 0) {
                        let th = tables[tableNum].querySelectorAll("th")[1];
                        th.textContent = sortKey;
                    }
                    let sorted = Object.entries(simple ? simple_dealin_rates : dealin_rates).sort((a, b) => {
                        return a[1][sortKey - 1] - b[1][sortKey - 1];
                    });
                    sorted.forEach((line) => {
                        const row = document.createElement("tr");
                        const key = line[0];
                        const rowData = line[1];
                        const headerCell = document.createElement("td");
                        headerCell.textContent = key;
                        if (key.includes("wind") || key.includes("Yakuhai") || key.includes("Honor")) {
                            headerCell.style.backgroundColor = "lightgreen";
                        }
                        row.appendChild(headerCell);
                        rowData.forEach((value, index) => {
                            if ((tableNum == 1 && index != earlyTurn - 1) || (tableNum == 2 && index != lateTurn - 1)) {
                                return;
                            }
                            const cell = document.createElement("td");
                            cell.textContent = value === 0 ? "N/A" : value.toFixed(1);
                            row.appendChild(cell);
                        });

                        tbody.appendChild(row);
                    });
                }
            }
            function shorten(label) {
                label = label.replace("Dama", "D").replace("Riichi", "R").replace(" pt", "").replace(",", "/");
                const lookup = {
                    "D 700": "pinfu nomi",
                    "D 1000": "+1",
                    "D 1300": "pinfu +1",
                    "D 2000": "+2",
                    "D 2600": "pinfu +2",
                    "D 3900": "+3",
                    "D 5200": "pinfu +3",
                    "D 6400": "40fu +3",
                    "D 7700": "+4",
                };
                let extra = "";
                for (const [key, val] of Object.entries(lookup)) {
                    if (label.includes(key)) {
                        extra = `<br>(${val})`;
                        break;
                    }
                }
                return `${label}${extra}`;
            }
            function flat2dict(arr) {
                return {
                    turn: {
                        5: { Riichi: arr[0], Dama: arr[1], Diff: arr[0] - arr[1] },
                        8: { Riichi: arr[2], Dama: arr[3], Diff: arr[2] - arr[3] },
                        12: { Riichi: arr[4], Dama: arr[5], Diff: arr[4] - arr[5] },
                    },
                    points: { Riichi: arr[6], Dama: arr[7], Diff: arr[6] - arr[7] },
                };
            }
            function riichi_dama_display(headers, handValues, waitType) {
                const table = document.createElement("table");
                const thead = document.createElement("thead");
                const tbody = document.createElement("tbody");

                const headerRow = document.createElement("tr");
                headers.forEach((key) => {
                    const th = document.createElement("th");
                    th.textContent = key;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);

                for (const [key, row] of Object.entries(handValues[waitType])) {
                    const tr = document.createElement("tr");
                    // console.log(key, row);
                    // Well this is kinda weird and verbose but copilot suggested it
                    const fullRow = [
                        key,
                        row.turn[5].Riichi,
                        row.turn[5].Dama,
                        row.turn[5].Diff,
                        row.turn[8].Riichi,
                        row.turn[8].Dama,
                        row.turn[8].Diff,
                        row.turn[12].Riichi,
                        row.turn[12].Dama,
                        row.turn[12].Diff,
                        row.points.Riichi,
                        row.points.Dama,
                        row.points.Diff,
                    ];
                    fullRow.forEach((cell, index) => {
                        const td = document.createElement("td");
                        td.textContent = cell !== null ? cell : "";
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                }

                table.appendChild(thead);
                table.appendChild(tbody);
                // document.body.appendChild(table);

                let trace_y_values = [[], [], []];
                for (const [key, dict] of Object.entries(handValues[waitType])) {
                    if (key.includes("nomi")) continue;
                    for (let [idx, turn] of [5, 8, 12].entries()) {
                        trace_y_values[idx].push(dict.turn[turn].Diff);
                    }
                }
                const traces = [5, 8, 12].map((turn, idx) => ({
                    x: Object.keys(handValues[waitType])
                        .filter((k) => k !== "Riichi nomi")
                        .map((r) => shorten(r)),
                    y: trace_y_values[idx],
                    type: "scatter",
                    mode: "lines+markers",
                    name: `T${turn}`,
                }));
                const layout = {
                    title: { text: `Riichi vs Dama difference for: ${waitType}` },
                };
                console.log(traces);
                let chartEl = document.createElement("div");
                chartEl.id = "chart-" + waitType.replace(/\s+/g, "-").toLowerCase();
                document.body.appendChild(chartEl);
                Plotly.newPlot(chartEl, traces, layout);
            }
            function riichi_dama_ev() {
                const headers = [
                    "Hand name",
                    "T5 Riichi",
                    "T5 Dama",
                    "T5 diff",
                    "T8 Riichi",
                    "T8 Dama",
                    "T8 diff",
                    "T12 Riichi",
                    "T12 Dama",
                    "T12 diff",
                    "Pts Riichi",
                    "Pts Dama",
                    "Pts Diff",
                ];

                const handValues = {};
                // Table 1.1: Head start ryanmen riichi/dama round balance. Round balance values are computed from game log
                // analysis results tabluated in 1.2. Expected round balance values are rounded to the nearest 10.
                handValues["Head start ryanmen"] = {
                    "Riichi nomi": [1300, null, 600, null, -100, null, 2800, null],
                    "Dama 700 pt, Riichi 1300 pt": [1500, 300, 800, -100, 0, -400, 3200, 900],
                    "Dama 1000 pt, Riichi 2000 pt": [1900, 600, 1100, 200, 300, -300, 3700, 1100],
                    "Dama 1300 pt, Riichi 2600 pt": [2800, 1000, 1900, 500, 900, 0, 5000, 1500],
                    "Dama 2000 pt, Riichi 3900 pt": [3600, 1600, 2600, 1000, 1400, 400, 6300, 2200],
                    "Dama 2600 pt, Riichi 5200 pt": [4500, 2300, 3400, 1600, 1900, 800, 7600, 3000],
                    "Dama 3900 pt, Riichi 7700 pt": [5500, 3400, 4200, 2600, 2600, 1600, 9100, 4300],
                    "Dama 5200 pt, Riichi 4 han": [5600, 4800, 4300, 3800, 2600, 2500, 9200, 6000],
                    "Dama 6400 pt, Riichi 4 han": [5600, 5600, 4300, 4500, 2600, 3000, 9200, 6900],
                    "Dama 7700 pt, Riichi 5 han": [7000, 6300, 5500, 5100, 3500, 3600, 11300, 7800],
                    "Dama 4 han, Riichi 5 han": [7000, 6500, 5500, 5300, 3500, 3700, 11300, 8000],
                    "Dama 5 han, Riichi 6 han": [8300, 7500, 6500, 6100, 4300, 4400, 13100, 9200],
                    "Dama 6 han, Riichi 7 han": [9600, 9900, 7600, 8200, 5100, 5900, 15100, 12000],
                };

                // Table 1.3: Head start bad shape riichi/dama round balance. Round balance values are computed from data
                // tabulated in Table 1.4. The points scored upon winning differ slightly from the corresponding values for ryanmen
                // riichi due to some differences in ippatsu and tsumo rates.
                // Riichi/dama confirmed hand value Turn 5 Turn 8 Turn 12 Points scored
                // Riichi Dama Riichi Dama Riichi Dama Riichi Dama
                handValues["Head start bad shape"] = {
                    "Riichi nomi": [500, null, -100, null, -600, null, 2600, null],
                    "Dama 1300 pt, Riichi 2600 pt": [1600, 500, 800, 0, 0, -500, 4700, 1500],
                    "Dama 2600 pt, Riichi 5200 pt": [2900, 1600, 1900, 900, 800, 100, 7300, 3000],
                    "Dama 5200 pt, Riichi 4 han": [3800, 3800, 2700, 2600, 1400, 1300, 9000, 6000],
                    "Dama 6400 pt, Riichi 4 han": [3800, 4500, 2700, 3100, 1400, 1700, 9000, 6900],
                    "Dama 4 han, Riichi 5 han": [4800, 5300, 3500, 3700, 1900, 2100, 10900, 8000],
                    "Dama 5 han, Riichi 6 han": [5900, 6100, 4300, 4400, 2600, 2600, 12900, 9200],
                    "Dama 6 han, Riichi 7 han": [6900, 8200, 5200, 6000, 3100, 3700, 14800, 12000],
                };

                // Table 1.6: Head start honor wait riichi/dama round balance. Round balance values are computed from data
                // tabulated in Table 1.7.
                // Riichi/dama confirmed hand value Turn 5 Turn 8 Turn 12 Points scored
                // Riichi Dama Riichi Dama Riichi Dama Riichi Dama
                handValues["Head start honor wait"] = {
                    "Riichi nomi": [1100, null, 400, null, -300, null, 2600, null],
                    "Dama 1300 pt, Riichi 2600 pt": [2400, 700, 1500, 100, 500, -400, 4600, 1500],
                    "Dama 2600 pt, Riichi 5200 pt": [4200, 1800, 2900, 1000, 1500, 200, 7100, 3000],
                    "Dama 5200 pt, Riichi 4 han": [5400, 4100, 3900, 2700, 2300, 1500, 8900, 6000],
                    "Dama 6400 pt, Riichi 4 han": [5400, 4800, 3900, 3200, 2900, 1900, 8900, 6900],
                    "Dama 4 han, Riichi 5 han": [6600, 5700, 4900, 3900, 3000, 2300, 10700, 8000],
                    "Dama 5 han, Riichi 6 han": [8100, 6600, 6100, 4600, 3900, 2800, 12900, 9200],
                    "Dama 6 han, Riichi 7 han": [9300, 8700, 7000, 6200, 4500, 4000, 14600, 12000],
                };

                // Convert from flat rows to dict
                for (let [waitType, dict] of Object.entries(handValues)) {
                    for (let [value, row] of Object.entries(dict)) {
                        dict[value] = flat2dict(row);
                    }
                }

                riichi_dama_display(headers, handValues, "Head start ryanmen");
                riichi_dama_display(headers, handValues, "Head start bad shape");
                // riichi_dama_display(headers, handValues, "Head start honor wait");
            }

            function push_fold_ev(h_dealer, v_dealer) {
                // turn 9 riichi
                const v_tsumo_value = v_dealer ? 10000 : 7000;
                const v_tsumo_rate = 0.4;
                const draw_rate = 0.3;
                const lateral_rate = 1.0 - v_tsumo_rate - draw_rate;

                const tsumo_payment_share = v_dealer ? 1 / 3 : h_dealer ? 1 / 2 : 1 / 4;
                var tsumo_payment = v_tsumo_value * tsumo_payment_share;
                tsumo_payment = (tsumo_payment / 100).toFixed(0) * 100; // SMS seems to round these up?
                const draw_payment = 1200; // some mix of 1000 and 1500
                const lateral_payment = 0;
                const fold_ev = v_tsumo_rate * tsumo_payment + draw_rate * draw_payment + lateral_rate * lateral_payment;

                // fold_ev 0 0 0.25 1750.00 1060.00  As a non dealer, the point loss upon opponent tsumo is then 1800 points (rounded up from 1750?)
                // fold_ev 0 1 0.33 3333.33 1693.33
                // fold_ev 1 0 0.50 3500.00 1760.00
                // console.log("fold_ev", h_dealer, v_dealer, tsumo_payment_share.toFixed(2), tsumo_payment.toFixed(2), fold_ev.toFixed(2));

                // Chase - Ryanmen - T11
                const winrate = 0.44;
                const riichi_dealin_rate = 0; // 0.1
                const dealin_after_riichi_pass_rate = 0.15;
                const dealin_rate_total = riichi_dealin_rate + (1 - riichi_dealin_rate) * dealin_after_riichi_pass_rate;
                const v_chased_tsumo_rate = 0.22; // is this some sort of formula based on the 0.44? TODO riichi dealin case
                const chased_lateral_rate = 11; // TODO richi dealin case
                const chase_draw_rate = 1 - v_chased_tsumo_rate - winrate - dealin_rate_total - chased_lateral_rate;
                const win_is_tsumo = 0.42;
                const win_is_ippatsu = 0.3;
                const ura_rate = 0.3; // add in ura 2 chance
                const extra_han = [
                    (1 - ura_rate) * (1 - win_is_ippatsu), // 0 extra
                    ura_rate * (1 - win_is_ippatsu) + (1 - ura_rate) * win_is_ippatsu, // 1 extra
                    ura_rate * win_is_ippatsu, // 2 extra
                ];
                const chase_win_value =
                    1300 * (1 - win_is_tsumo) * extra_han[0] +
                    2600 * (1 - win_is_tsumo) * extra_han[1] +
                    5200 * (1 - win_is_tsumo) * extra_han[2] +
                    2000 * win_is_tsumo * extra_han[0] +
                    4000 * win_is_tsumo * extra_han[1] +
                    8000 * win_is_tsumo * extra_han[2];
                // console.log(extra_han);

                const chase_ev = winrate * (chase_win_value + 1000) - dealin_rate_total * (v_tsumo_value + 1000) - v_chased_tsumo_rate * (tsumo_payment + 1000);
                // console.log(chase_win_value, chase_ev);
            }
            push_fold_ev(0, 0);
            push_fold_ev(0, 1);
            push_fold_ev(1, 0);
            riichi_dama_ev();
            simplify_types();
            updateTable(9, 15, true);
            document
                .getElementById("plotForm")
                .querySelectorAll("input")
                .forEach((input) => {
                    input.addEventListener("change", (event) => {
                        event.preventDefault();
                        const earlyTurn = parseInt(document.getElementById("earlyTurn").value);
                        const lateTurn = parseInt(document.getElementById("lateTurn").value);
                        const simple = document.getElementById("simple").checked;
                        console.log(simple);
                        updateTable(earlyTurn, lateTurn, simple);
                    });
                });
        </script>
    </body>
</html>
